<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Your Cart | NEXUS</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <link rel="stylesheet" href="cart.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <!-- Mobile Header -->
    <header class="mobile-header">
      <div class="header-content">
        <a href="index.html" class="logo">NEX<span>US</span></a>
        <div class="header-actions">
          <a href="index.html" class="back-btn">
            <i class="fas fa-arrow-left"></i>
          </a>
          <div class="cart-icon">
            <i
              class="fas fa-shopping-bag"
              style="color: white; font-size: 24px"
            ></i>
            <span class="cart-count" id="cart-count">0</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Cart Content -->
    <div class="cart-container">
      <h1 class="cart-title">Your Cart</h1>
      <div id="cart-content">
        <!-- Content will be loaded here -->
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <p class="loading-text">Loading your cart...</p>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "https://backendroutes-lcpt.onrender.com";
      const cartContent = document.getElementById("cart-content");

      // Check login
      const user = JSON.parse(localStorage.getItem("user"));

      if (!user) {
        cartContent.innerHTML = `
                <div class="login-prompt">
                    <i class="fas fa-shopping-bag"></i>
                    <h2>Sign In Required</h2>
                    <p>Please log in to view your shopping cart and manage your items.</p>
                    <a href="login.html" class="login-btn">Sign In to View Cart</a>
                </div>
            `;
      } else {
        // Load cart for logged in user
        loadCart();
      }

      async function loadCart() {
        try {
          // 1️⃣ Get cart rows
          const cartRes = await fetch(`${API_BASE}/cart/${user.id}`);
          const cartItems = await cartRes.json();

          if (cartItems.length === 0) {
            cartContent.innerHTML = `
                        <div class="empty-cart">
                            <i class="fas fa-shopping-cart"></i>
                            <h2>Your Cart is Empty</h2>
                            <p>Looks like you haven't added any items to your cart yet. Start shopping to fill it up!</p>
                            <a href="index.html" class="continue-btn">Continue Shopping</a>
                        </div>
                    `;
            return;
          }

          // 2️⃣ Extract product IDs
          const productIds = cartItems.map((item) => item.product_id);

          // 3️⃣ Fetch products
          const productRes = await fetch(`${API_BASE}/products/by-ids`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ productIds }),
          });

          const products = await productRes.json();

          // 4️⃣ Merge cart + product data
          const merged = cartItems.map((cartItem) => {
            const product = products.find((p) => p.id === cartItem.product_id);
            return {
              ...product,
              size: cartItem.size,
              cart_id: cartItem.id,
              quantity: cartItem.quantity || 1,
            };
          });

          renderCart(merged);

          // Update cart count
          document.getElementById("cart-count").textContent = cartItems.length;
        } catch (err) {
          console.error(err);
          cartContent.innerHTML = `
                    <div class="error-container">
                        <div class="error-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <p class="error-text">Failed to load cart. Please check your connection.</p>
                        <button onclick="loadCart()" class="retry-btn">Try Again</button>
                    </div>
                `;
        }
      }

      function renderCart(items) {
        // Calculate totals
        const subtotal = items.reduce((sum, item) => {
          return sum + parseFloat(item.price) * (item.quantity || 1);
        }, 0);

        const shipping = subtotal > 100 ? 0 : 9.99;
        const tax = subtotal * 0.08;
        const total = subtotal + shipping + tax;

        cartContent.innerHTML = `
                <div class="cart-items-container">
                    ${items
                      .map(
                        (item) => `
                        <div class="cart-item" data-id="${item.cart_id}">
                            <div class="item-header">
                                <div class="item-image">
                                    <img src="${item.img_url}" alt="${
                          item.name
                        }">
                                </div>
                                <div class="item-info">
                                    <h3 class="item-name">${item.name}</h3>
                                    <div class="item-details">
                                        <p>Size: ${item.size}</p>
                                        <p>Color: Black/White</p>
                                    </div>
                                    <div class="item-price">$${(
                                      parseFloat(item.price) *
                                      (item.quantity || 1)
                                    ).toFixed(2)}</div>
                                </div>
                            </div>
                            
                            <div class="item-actions">
                                <div class="quantity-control">
                                    <button class="qty-btn minus" onclick="updateQuantity(${
                                      item.cart_id
                                    }, 'decrease')">-</button>
                                    <input type="text" class="qty-input" value="${
                                      item.quantity || 1
                                    }" readonly>
                                    <button class="qty-btn plus" onclick="updateQuantity(${
                                      item.cart_id
                                    }, 'increase')">+</button>
                                </div>
                                
                                <button class="remove-btn" onclick="removeItem(${
                                  item.cart_id
                                })">
                                    <i class="fas fa-trash"></i>
                                    <span>Remove</span>
                                </button>
                            </div>
                        </div>
                    `
                      )
                      .join("")}
                </div>
                
                <div class="order-summary">
                    <h3 class="summary-title">Order Summary</h3>
                    <div class="summary-row">
                        <span>Subtotal (${items.length} items)</span>
                        <span>$${subtotal.toFixed(2)}</span>
                    </div>
                    <div class="summary-row">
                        <span>Shipping</span>
                        <span>${
                          shipping === 0 ? "FREE" : `$${shipping.toFixed(2)}`
                        }</span>
                    </div>
                    <div class="summary-row">
                        <span>Tax</span>
                        <span>$${tax.toFixed(2)}</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total</span>
                        <span>$${total.toFixed(2)}</span>
                    </div>
                    
                    <button class="checkout-btn" onclick="checkout()">
                        <i class="fas fa-lock"></i> PROCEED TO CHECKOUT
                    </button>
                </div>
            `;
      }

      // Placeholder functions for cart actions
      function removeItem(cartId) {
        if (confirm("Remove this item from your cart?")) {
          // In a real app, you would call DELETE /cart/:id
          // fetch(`${API_BASE}/cart/${cartId}`, { method: 'DELETE' })
          alert("Item removed from cart");
          loadCart(); // Reload cart
        }
      }

      function updateQuantity(cartId, action) {
        // In a real app, you would call PATCH /cart/:id
        // fetch(`${API_BASE}/cart/${cartId}`, {
        //     method: 'PATCH',
        //     headers: { 'Content-Type': 'application/json' },
        //     body: JSON.stringify({ action: action })
        // })
        alert(`Quantity ${action === "increase" ? "increased" : "decreased"}`);
        loadCart(); // Reload cart
      }

      function checkout() {
        alert("Proceeding to checkout...");
        // window.location.href = 'checkout.html';
      }
    </script>
  </body>
</html>
