<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Your Cart | NEXUS</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Helvetica Neue", Arial, sans-serif;
      }

      body {
        background-color: #f8f9fa;
        color: #111111;
        min-height: 100vh;
      }

      /* Header */
      .header {
        background-color: #111111;
        color: white;
        padding: 20px 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }

      .header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        font-size: 28px;
        font-weight: 700;
        color: white;
        text-decoration: none;
        letter-spacing: -1px;
      }

      .logo span {
        color: #ff6b35;
      }

      .nav-links {
        display: flex;
        gap: 30px;
      }

      .nav-links a {
        color: white;
        text-decoration: none;
        font-weight: 600;
        font-size: 15px;
        text-transform: uppercase;
        transition: color 0.3s;
      }

      .nav-links a:hover {
        color: #ff6b35;
      }

      .cart-icon {
        position: relative;
      }

      .cart-count {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #ff6b35;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
      }

      /* Cart Page */
      .cart-page {
        padding: 40px 0 80px;
      }

      .cart-title {
        font-size: 36px;
        font-weight: 700;
        margin-bottom: 40px;
        text-align: center;
        text-transform: uppercase;
        color: #111111;
      }

      .cart-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 40px;
      }

      /* Cart Items */
      .cart-items {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
      }

      .empty-cart {
        text-align: center;
        padding: 60px 20px;
        color: #8e8e8e;
        font-size: 18px;
      }

      .empty-cart i {
        font-size: 48px;
        margin-bottom: 20px;
        color: #ddd;
      }

      .cart-item {
        display: grid;
        grid-template-columns: 120px 1fr auto;
        gap: 25px;
        padding: 25px 0;
        border-bottom: 1px solid #eee;
        align-items: center;
      }

      .cart-item:last-child {
        border-bottom: none;
      }

      .cart-item-img {
        width: 120px;
        height: 120px;
        border-radius: 10px;
        overflow: hidden;
        background: #f5f5f5;
      }

      .cart-item-img img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s;
      }

      .cart-item:hover .cart-item-img img {
        transform: scale(1.05);
      }

      .cart-item-info h3 {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 10px;
      }

      .cart-item-details {
        color: #8e8e8e;
        font-size: 14px;
        margin-bottom: 15px;
      }

      .cart-item-price {
        font-size: 20px;
        font-weight: 700;
        color: #111111;
      }

      .cart-item-actions {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 15px;
      }

      .quantity-selector {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #f5f5f5;
        border-radius: 8px;
        padding: 8px 12px;
      }

      .quantity-btn {
        background: none;
        border: none;
        color: #111111;
        font-size: 18px;
        cursor: pointer;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.3s;
      }

      .quantity-btn:hover {
        background: #ddd;
      }

      .quantity-input {
        width: 40px;
        text-align: center;
        border: none;
        background: transparent;
        font-size: 16px;
        font-weight: 600;
      }

      .remove-btn {
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        font-size: 14px;
        transition: color 0.3s;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .remove-btn:hover {
        color: #c82333;
      }

      /* Order Summary */
      .order-summary {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        height: fit-content;
        position: sticky;
        top: 30px;
      }

      .summary-title {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f5f5f5;
      }

      .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        color: #555;
      }

      .summary-row.total {
        font-size: 20px;
        font-weight: 700;
        color: #111111;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px solid #f5f5f5;
      }

      .checkout-btn {
        width: 100%;
        padding: 18px;
        background: #111111;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 25px;
      }

      .checkout-btn:hover {
        background: #ff6b35;
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(255, 107, 53, 0.3);
      }

      .continue-shopping {
        display: inline-block;
        text-align: center;
        width: 100%;
        margin-top: 20px;
        color: #8e8e8e;
        text-decoration: none;
        font-weight: 600;
        transition: color 0.3s;
      }

      .continue-shopping:hover {
        color: #ff6b35;
      }

      /* Login Prompt */
      .login-prompt {
        text-align: center;
        padding: 80px 20px;
        max-width: 500px;
        margin: 0 auto;
      }

      .login-prompt i {
        font-size: 64px;
        color: #ff6b35;
        margin-bottom: 30px;
      }

      .login-prompt h2 {
        font-size: 28px;
        margin-bottom: 20px;
      }

      .login-prompt p {
        color: #8e8e8e;
        margin-bottom: 30px;
        font-size: 16px;
      }

      .login-btn {
        display: inline-block;
        background: #ff6b35;
        color: white;
        padding: 15px 40px;
        text-decoration: none;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        border-radius: 30px;
        transition: all 0.3s;
      }

      .login-btn:hover {
        background: #ff8535;
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      }

      /* Loading */
      .loading {
        text-align: center;
        padding: 60px 20px;
        color: #8e8e8e;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #f5f5f5;
        border-top-color: #ff6b35;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Responsive */
      @media (max-width: 992px) {
        .cart-grid {
          grid-template-columns: 1fr;
        }

        .order-summary {
          position: static;
        }
      }

      @media (max-width: 768px) {
        .cart-item {
          grid-template-columns: 100px 1fr;
          gap: 20px;
        }

        .cart-item-actions {
          grid-column: 1 / -1;
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
        }

        .nav-links {
          display: none;
        }
      }

      @media (max-width: 480px) {
        .cart-item {
          grid-template-columns: 1fr;
          text-align: center;
        }

        .cart-item-img {
          margin: 0 auto;
        }

        .cart-item-actions {
          flex-direction: column;
          gap: 15px;
        }

        .cart-title {
          font-size: 28px;
        }
      }
    </style>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="container header-container">
        <a href="index.html" class="logo">NEX<span>US</span></a>

        <div class="nav-links">
          <a href="index.html">Home</a>
          <a href="products.html">Shop</a>
          <a href="#">Men</a>
          <a href="#">Women</a>
          <a href="#">Collections</a>
        </div>

        <div class="cart-icon">
          <a href="cart.html" style="color: white; font-size: 20px">
            <i class="fas fa-shopping-bag"></i>
            <span class="cart-count" id="cart-count">0</span>
          </a>
        </div>
      </div>
    </header>

    <!-- Cart Page -->
    <div class="cart-page container">
      <h1 class="cart-title">Your Shopping Cart</h1>

      <div id="cart-container">
        <!-- Content will be loaded by JavaScript -->
        <div class="loading">
          <div class="loading-spinner"></div>
          <p>Loading your cart...</p>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "https://backendroutes-lcpt.onrender.com";
      const cartContainer = document.getElementById("cart-container");

      // Check login
      const user = JSON.parse(localStorage.getItem("user"));

      if (!user) {
        cartContainer.innerHTML = `
                <div class="login-prompt">
                    <i class="fas fa-shopping-bag"></i>
                    <h2>Sign In Required</h2>
                    <p>Please log in to view your shopping cart and manage your items.</p>
                    <a href="login.html" class="login-btn">Sign In</a>
                </div>
            `;
      } else {
        // Load cart for logged in user
        loadCart();
      }

      async function loadCart() {
        try {
          // 1️⃣ Get cart rows
          const cartRes = await fetch(`${API_BASE}/cart/${user.id}`);
          const cartItems = await cartRes.json();

          if (cartItems.length === 0) {
            cartContainer.innerHTML = `
                        <div class="empty-cart">
                            <i class="fas fa-shopping-cart"></i>
                            <h2>Your Cart is Empty</h2>
                            <p>Looks like you haven't added any items to your cart yet.</p>
                            <a href="index.html" class="continue-shopping">Continue Shopping</a>
                        </div>
                    `;
            return;
          }

          // 2️⃣ Extract product IDs
          const productIds = cartItems.map((item) => item.product_id);

          // 3️⃣ Fetch products
          const productRes = await fetch(`${API_BASE}/products/by-ids`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ productIds }),
          });

          const products = await productRes.json();

          // 4️⃣ Merge cart + product data
          const merged = cartItems.map((cartItem) => {
            const product = products.find((p) => p.id === cartItem.product_id);
            return { ...product, size: cartItem.size, cart_id: cartItem.id };
          });

          renderCart(merged);

          // Update cart count
          document.getElementById("cart-count").textContent = cartItems.length;
        } catch (err) {
          console.error(err);
          cartContainer.innerHTML = `
                    <div class="empty-cart">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h2>Failed to Load Cart</h2>
                        <p>There was an error loading your cart. Please try again.</p>
                        <button onclick="loadCart()" class="login-btn">Retry</button>
                    </div>
                `;
        }
      }

      function renderCart(items) {
        // Calculate totals
        const subtotal = items.reduce(
          (sum, item) => sum + parseFloat(item.price),
          0
        );
        const shipping = subtotal > 100 ? 0 : 9.99;
        const tax = subtotal * 0.08;
        const total = subtotal + shipping + tax;

        cartContainer.innerHTML = `
                <div class="cart-grid">
                    <div class="cart-items">
                        ${items
                          .map(
                            (item) => `
                            <div class="cart-item" data-id="${item.cart_id}">
                                <div class="cart-item-img">
                                    <img src="${item.img_url}" alt="${item.name}">
                                </div>
                                <div class="cart-item-info">
                                    <h3>${item.name}</h3>
                                    <div class="cart-item-details">
                                        <p>Size: ${item.size} | Color: Black/White</p>
                                        <p>Item #${item.id}</p>
                                    </div>
                                    <div class="cart-item-price">$${item.price}</div>
                                </div>
                                <div class="cart-item-actions">
                                    <div class="quantity-selector">
                                        <button class="quantity-btn minus">-</button>
                                        <input type="text" class="quantity-input" value="1" readonly>
                                        <button class="quantity-btn plus">+</button>
                                    </div>
                                    <button class="remove-btn" onclick="removeItem(${item.cart_id})">
                                        <i class="fas fa-trash"></i> Remove
                                    </button>
                                </div>
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                    
                    <div class="order-summary">
                        <h3 class="summary-title">Order Summary</h3>
                        <div class="summary-row">
                            <span>Subtotal (${items.length} items)</span>
                            <span>$${subtotal.toFixed(2)}</span>
                        </div>
                        <div class="summary-row">
                            <span>Shipping</span>
                            <span>${
                              shipping === 0
                                ? "FREE"
                                : `$${shipping.toFixed(2)}`
                            }</span>
                        </div>
                        <div class="summary-row">
                            <span>Tax</span>
                            <span>$${tax.toFixed(2)}</span>
                        </div>
                        <div class="summary-row total">
                            <span>Total</span>
                            <span>$${total.toFixed(2)}</span>
                        </div>
                        
                        <button class="checkout-btn">Proceed to Checkout</button>
                        <a href="index.html" class="continue-shopping">Continue Shopping</a>
                    </div>
                </div>
            `;
      }

      // Placeholder functions for cart actions
      function removeItem(cartId) {
        if (confirm("Remove this item from your cart?")) {
          // In a real app, you would call DELETE /cart/:id
          alert("Item removed from cart");
          loadCart(); // Reload cart
        }
      }

      // Simulate quantity changes
      document.addEventListener("click", function (e) {
        if (e.target.classList.contains("quantity-btn")) {
          const input = e.target.parentElement.querySelector(".quantity-input");
          let value = parseInt(input.value);

          if (e.target.classList.contains("plus")) {
            value++;
          } else if (e.target.classList.contains("minus") && value > 1) {
            value--;
          }

          input.value = value;
        }
      });
    </script>
  </body>
</html>
